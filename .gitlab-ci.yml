image:
  name: galacticfog/docker-yarn-debian:8.11.3

stages:
  - build-cli
  - build-image
  - test
  - deploy

services:
  - docker:dind

build-cli:
  stage: build-cli
  allow_failure: false
  script:
    - env | sort
    - npm install -g pkg 
    - VERSION=$(<package.json jq -r '.version')
    - echo "[Info][FOG CLI Version][${VERSION}]"
    - echo "[Info][CI_COMMIT_SHA][$CI_COMMIT_SHA]"
    - ./build-cli.sh
  artifacts:
    paths:
    - "./target/*/fog"

build-image:
  stage: build-image
  allow_failure: false
  dependencies: 
    - build-cli
  script:
    - apt-get install zip unzip
    - ls -la ./target
    - VERSION=$(<package.json jq -r '.version')
    - echo "[Info][FOG CLI Version][${VERSION}]"
    - echo "[Info][CI_COMMIT_SHA][$CI_COMMIT_SHA]"
    - echo $CI_BUILD_TOKEN | docker login $CI_REGISTRY --username gitlab-ci-token --password-stdin
    - ./build-image.sh "${VERSION} $CI_COMMIT_SHA"